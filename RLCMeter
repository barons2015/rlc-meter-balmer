RLCMeter

Измеряем напряжение на элементе и ток на сопротивлении которое последовательно с ним стоит.

R = 1/(2*PI*F*C)
R = (2*PI*F*L)

import math
def RFC(F,C): return 1/(2*math.pi*F*C)
def RFL(F,L): return 2*math.pi*F*L

F = 50 kHz
C = 1 mkF R = 3 Om
C = 1 nF R = 3 KOm
C = 1 pF R = 3 MOm

L = 1 mH R = 3 Om
L = 1 mkH R = 0.3 Om
L = 1 nH R = 0.3 mOm

F = 100 Hz
C = 1000 mkF R = 1.6 Om
C = 100 mkF R = 16 Om

L = 1 KH R = 628 KOm
L = 1 H R = 628 Om
L = 1 mH R = 0.6 Om

Теперь прикинем напряжение, какое можем измерять.
3.3 V напряжение измеряемое ADC
Максимальный коэффициэнт усиления 32
0.1 V при максимальном коэффициэнте
10 mA максимальный ток

100 Om == 0.1 V

Значит предусилитель x10 обязательно нужен.

Возможно лучше таки сделать "инструментальный" вариант, где резисторы переключаются с использованием реле.
74HC4052 c 100 ом проходного сопротивления - это всетаки несколько экстремально.
Это конечно несколько экстенсивно, зато позволит достаточно точно контролировать емкость параллельную сопротивлению.

Перед выходным усилителем таки сделать гальваническую развязку, это позволит избавиться от цепи подгонки постоянной составляющей напряжения.
Гальваническая развязка это не очень хорошо, потому как если будем измерять большое сопротивление, то постоянная составляющая долго может устаканиваться.

По выводам
74HC4052 == 4052
AD8532 == LM358

----------------------------
Пусть резисторы переключаются посредством 74HC4052, это экономично и мало места займет.
Пусть вход инструментального усилителя переключается посредством реле. Возьмем реле с двумя группами контактов.

Питать будем пока от USB, а в дальнейшем от батареек 6 V.
AD8532 - используем как обычные ОУ
AD8221 - инструментальный усилитель, пускай всегда усиливает в 1 и 20 раз.
MCP6S21 - усилитель с программируемым коэффициэнтом усиления 1..32 раза.

300 mV напряжение на выходе усилителей.

---------------------------
- нарисовать схему где есть два инструментальных усилителя для измерения тока и напряжения
- поставить дырки, чтобы подцепляться осциллографом

----------------------------
Перерисовал схему.

--------------

Воспользовался OP07C в качестве усилителя с низким Input Offset Voltage. В буфере/фильтре на выходе генератора частоты. И в "виртуальной земле" на 2.5 V.

Фильтр, который фильтрует DAC оставил того-же третьего порядка. Вроде должно хватать. Если учесть что будем на частоте 1 MHz сигнал генерировать, то там более чем достаточное подавление получается.

Инструментальные усилители все время работают с Ку=10 примерно. Все равно надо усиливать сигнал с 300 мВ до 3 В. Надеемся, что не будет между двумя ADC проникновения сигнала взаимного.

В генераторе тока применил AD825R микросхемку (она не работает от 5 V однополярного)


----------
- Убрать развязку по постоянному току между AD8221 и MCP6S21
- Сделать удобную функцию для запуска DAC с синусом разной частоты. --ok
	Когда минуса нет, то на выход DMA транслируется средняя амплитуда
	F = Fcpu/prescaler/BufferSize
	prescaler min = 30

- проверить, что ровно 600 кгц частоты --ok
	 	1000 samples = 119960
	 	2000 samples = 239949
	 	3000 samples = 359953
	 	получается 120 тактов на сэмпл при частоте 72 мгц
	 	20 тактов чатоты 12 мгц то есть соответствует расчетному 7.5+12.5 clock

- научиться запускать ADC одновременно с DAC --ok

- устанавливать правильную частоту дискретизации для ADC
	- максимальную частоту дискретизации по таймеру нереально установить, лучше прямо запускать
	 	6 сэмплов на 100 кгц
	 	60 сэмплов на 10 кгц
	 	600 сэмплов на 1 кгц
	 	На более низких частотах надо снижать частоту сэмплирования и увеличивать adc sampling time
	 		28.5+12.5 clock = 3.4 us time on 12 mhz
	 	например если будем считать нижней частотой 100 герц, что 100 кгц достаточно

- Сделать функцию для ADC DMA Dual Mode 

- теоретически решить вопрос, достаточно ли 6 точек -- достаточно!!!!
- посмотреть, на сколько получается сдвиг в зависимовти от того, сколько кругов прошло --сдвиг не меняется
- определить частоты на которых можно посчитать фазу/амплитуду
  adc_cycles/FCPU*N - количество секунд, для разрешенной частоты, начинаем с N=6 = 100 кгц
  F = FCPU/(adc_cycles*N)

- переделать установку частоты на такты процессора. --ok
- сделать, чтобы ADC корректно инициализировалось и при частотах ниже 600 герц
- снять данные на разных частотах
	- определить частоты --ok
	- нестабильно запускается ADC
		- попробовать запустить конверсию ADC и когда она закончится, запустить таймер DAC и запретить прерывание --не помогает
		- попробовать откалибровать ADC по выходу DAC и потов вычитать эту цифру

- прикрутить DUAL ADC и считывать/обработать данные с него --ok
- заняться таки железом --ok
	- сделать простешие щупы --ok
	- проверить, что текущая схемка работает
		схема работает, но из-за того что F107 у нас без фильтрации аналогового питания, получилось плохо
		так-же не учли, что REF пины усилителей кушают достаточно прилично

- добавить в Eagle символ STM32F303 для 100 ногого корпуса.
AD8603 имеет такие-же выводы как AD8605

- стандартный ряд сопротивлений
	1 1.2 1.5 1.8 2 2.2 2.4 2.7
	3 3.3 3.9 4.7 5.1 5.6 6.8 7.5 8.2 9.1 
-
	2.5 V, 1.5 V

	(R2+R3)/(R1+R2+R3) = 2.5/5
	(R3)/(R1+R2+R3) = 1.5/5

	R1 = 2.5
	R2 = 1
	R3 = 1.5

	R1 = 100 К
	R2 = 39 K
	R3 = 68 K
	U1 = 2.58 V
	U2 = 1.64 V

- переделать виртуальную землю на 2 LM258, а вход IC3 подключить напрямую к резисторам на 2.5 V ??????
	Проблемм с Voltage Offset быть не должно, так как LM258 усиливает в миллион раз по постоянному току.

	x/(100+x)=1.6/5
	5*x=160+1.6*x
	(5-1.6)*x=160

--------------------------------------------
Переходим на STM32F303
- скомпилировать минимальный проект --ok
- проверить FPU --ok
- прикрутить на новую USB библиотеку --ok
- запустить ADC/DAC --ok
- настроить ADC34, так как у нас для них платка сделана --ok

----------------
- разобраться с установкой резисторов --ok

----------------

- допаяли платку, получили 6 LSB ошибки. 
	Очень важно оказалось разводить аналоговую землю вблизи микроконтроллера,
	через нее шумы проникают очень сильно. Сократили длинну аналогового пина, 
	получилось уменьшить с 9 до 6 LSB ошибку. 

- управление MCP6S21 --ok

- записывать изначальные данные в json формате --ok
- стандартные графики T-I, T-V, I-V -ok
- "очищенный" график синусоиды с многократным усреднением --ok
- шум, который остался после очистки
- график задержки фазы по току/напряжению в зависимости от частоты

- open/short/load калибровку какую нить прикрутить
	open/short делаем на всех диапазонах сопротивлений
	когда щупы разомкнуты, смотрим максимум по напряжению на усилении 1x и минимум по току на усилении 32x
		не забываем что про то что есть определенная емкость и проникновение сигнала между каналами 
	когда щупы замкнуты смотрим минимум по напряжению на 32x усилении и максимум по току

	калибруем несколькими известными сопротивлениями
		например диапазон 100 ом можно откалибровать сопротивлениями примерно 1, 10, 100 ом

Ky операционного усилителя при 18 К = 3.74

- Автоматический выбор коэффициэнта усиления. --ok
- подсчет таки комплексного сопротивления --ok
	- амплитуда сигнала 
		для частот 100 - 10000 Гц 310 мВ
		для частоты 100 КГц 223 мВ 

- обработка данных на стороне микроконтроллера
	- усреднять данные "на лету" --ok
	- детектировать случай, когда "не успеваем" --ok
	- свертка с sin, cos --ok
		во float считать не успеваем, попробовать считать в int64_t --fail
		так как не успеваем считать, то просто копируем быстро данные в другой буфер, как успеем, так и посчитаем в double
		после расчетов, просим новый буфер.

- переделать протокол таким образом --ok
	- запуск DAC/ADC не означает, что данные надодятся в copy буфере --ok
	- требуем чтобы началось копирование в буфер отдельной командой --ok

- сделать чтобы DAC выбирал частоты, чтобы nsample было кратно 4 --ok
- переписать скрипт так, чтобы частота выставлялась отдельно. --ok
- автоматически выбирать резистор и диапазон усиления --ok
- пробегаться по всему диапазону, читать только LAST_COMPUTE данные
	- читать только LAST_COMPUTE в setGainAuto


- вынести вычислительную часть в отдельный файл, а то adc.c уже длинноват. --ok
- добавить вычисление среднеквадратической ошибки --ok
- разобраться почему на некоторых частотах на 100 uH растет ошибка --ok
- перепаять конденсатор, чтобы 375 КГц не ослаблялось особо. --ok
	C2 100 p -> 33 p
- перепаять резисторы, чтобы "земляное" напряжение на MCP6S21 стало --ok
	R30 100 K -> 56 K


- постоянно считать, что получилось. Усреднять данные за секунду.
- поправить usb_desc.c, чтобы там не было Stm Microelectronics

- Open/Short/Load калибровка
	есть куча неиспользуемых вариантов комбинаций коэффициэнтов усиления
	пока поступим так - оттестируем на тех вариантах, что автоматом выбираются, 
	а если выберится неожиданных коэффициэнт - то возмем с соседнего цифры.

	Все измерения производятся для каждой частоты отдельно
		- измерение замкнутых щупов для R=100 Ом
		- измерение разомкнутых щупов для R=100 КОм
		- измерение известных резисторов 1 Ом, 10 Ом, 100 Ом, 1 КОм, 10 КОм, 100 КОм

		- для эмуляции Open/Short поступаем так 
			скажем есть диапазон 1 КОм
			Калибруем его на 100 Ом, 1 КОм, 10 КОм

		- для упрощения пока считаем, что коэффициэнты усиления абсолютно правильные

		- проведем Open/Short/Load калибровку на диапазоне 100 Ом
			Будем калибровать первым попавшимся резистором в диапазоне 10-100 Ом
			Измерить Zstdm - измеренное сопротивление резистора без корректировки
			Измерить Zsm - измеренное при замкнутых щупах
			Измерить Zom - измеренное при разомкнутых щупах

- пускай будем измерять на краях диапазона.
	не забываем прибавить к 1 MOm резистору емкость щупов!

	R = 9.94 MOm
	2.656 MOm
	R0 = 1.014 MОm  1.013 MOm
	R01 = 3.674 MOm 3.671 MOm
	R012 = 4.656 MOm 4.655 MOm

	Для высоких аопротивлений необходима схема замещения с параллельным конденсатором/сопротивлением.


	Z1 = (A*Z2+B)/(C*Z2+D)
	Z1*(C*Z2+D) = A*Z2+B
	Z1*C*Z2+D*Z1 -A*Z2 - B = 0
	Z2*(Z1*C-A) = B-D*Z1
	Z2 = (-D*Z1-B)/(Z1*C-A)

	1/(1/R+W*C*j)

- калибруем относительное усиление
	калибруем на частоте 1000 Гц
	примем усиление по току с нулевым индексом за 1

	R = 200 Om
		K = 0 Rm = 197.94
		K = 1 Rm = 198.04

	R = 1000 Om
		K = 1 Rm = 987.57
		K = 2 Rm = 987.43
		K = 3 Rm = 989.75

	R = 2200 Om
		K = 3 Rm = 2187.48
		K = 4 Rm = 2189.64 
		K = 5 Rm = 2186.88 

	R = 10 KOm
		K = 5 Rm = 9857.5
		K = 6 Rm = 9881.9
		K = 7 Rm = 9886.8

	относительное усиление бесполезно калибровать, слишком мала ошибка.

- около частоты 2870 на резиторе 10 КОМ странный скачек
	period 25632
	period 24000
	в этот момент происходит переход от 1 MHz к 3 МГц DAC
	Попробуем сделать этот переход мягче

- измеряем коррекцию коэффициэнтов усиления
	измеряем на 1000 Гц, ибо на частоте 100 Гц есть небольшое ослабление из-за конденсаторов
	K0 = 197.9/200
	K1 = 992.2/1e3
	K2 = 9957.6/10e3
	K3 = 99719/100e3

- измерить таки коэффициэнты усиления на всех частотах и посмотреть что с этим сделать можно
	на частотах 100 Гц - 1000 Гц точно нужна корректировка коэффициэнта, ибо завал небольшой наблюдается. 
	Хотя из-за того что завал в двух каналах - он както компенсируется.

- проблемма при измерении емкости 910 pF на диапазоне 100-200 Гц
	решили проблемму увеличив в фильтре после ADC конденсатор.

	Надо таки поставить для низких чатот дополнительный фильтр. А для высоких частот сузить полосу фильтрации с 400 КГц до 200 КГц.

- переделать pcd8544 драйвер под 16 битные команды. Чтобы передавать команды через тот-же SPI, что и для MCP6S21 --ok

- новые печатные платы и изменение схемотехники
	- аналоговая часть
		- увеличить конденсаторы в фильтре перед IC1 чтобы был срез на 200 КГц
		- добавить включающийся конденсатор 3.3nF, чтобы для низких частотах был синус круглый --ok
		- перенести коннекторы, чтобы они были меньшим количеством плашек.
		- добавить дырку для заземления на корпус
		- расположить более компактно детальки под размер 53x50 мм, не забыть про дырки для батарей
		- по краям оставить место для винтов стягивающих
	- цифровая часть
		- 39.2 mm примерное расстояние между двумя панельками для выводов у LCD Nokia 5110 --ok
		- разместить коннекторы для дисплея на одной стороне --ok
		- разместить коннекторы для аналоговой части на другой стороне --ok
		- добавить переключатель питания батарея/USB --ok
		- объединить X3, X5  --ok
		- перевести таки R4 на какой нибудь из пинов, чтобы USB корректно инициализировалось после перепрошивки. --ok
		- добавить пины для энкодера --ok
			возможно PA6, PA7 TIM3
			PA5 - кнопка
		- переделать высоту под 49 мм, чтобы можно было разрезать кусок 10 см на два нормально пилился --ok
		- по краям оставить место для винтов, которыми будет крепиться к корпусу и винтов стягивающих две платы. --ok
		- объединить GND и GNDA --ok
		- добавить сопротивления для измерения напряжения батареи --ok
			PC5 (34) - ADC2_IN11

	
	- X=51.435 Y=26.035  - положение восточного коннектора --ok
	   SCK
	   MOSI
	   CS_V
	   CS_I
	   V_ADC
	   I_ADC


	- перенести конденсаторы которые должны стоять около ADC поближе к выходам ADC, теоретически это уменьшит уровень шума --ok
	- сделать mirror всем коннекторам на цифровой части,
		 которые идут к аналоговой части,
		 подвести к ним провода по bottom дорожкам

		 - южный --ok
		 - восточный --ok
		 - северный X=22.86 Y=46.0375 --ok

	- добавить RC цепочку между первым и вторым усилительным каскадом, чтобы отсечь выше 200 КГц --ok
	- не забыть второй коннектора для LCD Nokia 5110, который ни к чему не подключен --ok
		X = 37.465 Y=4.445+39.2

- энкодер запрограмировать --ok
	на демоплате такая разводка
	красный - GND
	белый - PC8 - кнопка
	черный - PA8 (67) - энкодер TIM1_CH1
	отдельный черный  - PA9 (68) TIM1_CH2
	зеленый - PA10 - светодиод
	синий - никуда не подключен

- проверить что правильно повернут коннектор, от которого идет синусоидальный сигнал и 3.3 nF переключатель конденсатора --ok
	не правтильно были земля и питание.

- спаяли новые платы
	- PC6 USB_ON подключить --ok
	- проверить, что какието данные идут с аналоговой части --ok
	- PB10 AN_SW подключить --ok
	- подключить дисплей --ok
		- текущая частота --ok
		- статус подключения USB
	
- убрать из platform config ненужные дефайн

- экран 84x48
	ширина буквы 6 пикселей вместе с расстоянием между буквами

_12345678901234_
1USB 100KHz PWR1
2СССССССС      2
3СССССССС mkF  3
4RRRRRRRR      4
5RRRRRRRR KOm  5
6      12%     6
_12345678901234_



СССССССС - четыре символа включая точку, основной параметр
RRRRRRRR - дополнителный параметр
после параметра идет мелкими буквами uF, KOm и т/д
На нижней строчке точность в %


_12345678901234_
1USB 100KHz PWR1
2 100 мВ KU=7  2
3 12 мВ  KI=1  3
4 100 КОм      4
5              5
6      12%     6
_12345678901234_

Меню
 Частота
 Выбор схемы замещения

---------
- начинаем делать графический интерфейс на Qt
	- процедура калибровки
		- сначала проволим калибровку на низких частотах
		- short калибровка 
		- load калибрация на 100 ом/1 КОм/10 КОм/ 100 КОм 
			для определения правильного значения сопротивлений (сюдаже войдет и дисбаланс коэффициэнтов усиления в разных каналах)
		- open калибровка

	- графики

	- диалог: установить частоту и смотреть каждую секунду результат

	- фазовый сдвиг по каналам --fail
		по V при открытых щупах
		по I при замкнутых
		такого определения фазового сдвига недостаточно!
		таки надо фазовый сдвиг при каждом из сопротивлений!!!!

	- емкость щупов определить на частоте 100 КГц по амплитуде сигнала (считаем сопротивление между щупами бесконечным) --fail
	- обычная Open/Load калибровка отлично себя показывает на 100 КОм диапазоне

----------
Z1 = (A*Z2+B)/(C*Z2+D)

Zdut = (Zm-Zs)/(1-(Zm-Zs)*Yo)
Zs — импеданс при закороченных зажимах.
Yo — проводимость при разомкнутых режимах
Zm — измеренное прибором значение
Zdut — вычисленное скорректированное значение.

Для диапазона 1 КОм - 10 КОм можно пренебречь Zs
Zdut = A*Zm+B

Z1 = A*Zm1+B
Z2 = A*Zm2+B

A = (Z2-Z1)/(Zm2-Zm1)

B = Z1-Zm1*(Z2-Z1)/(Zm2-Zm1)

B = (Z1*(Zm2-Zm1)-Zm1*(Z2-Z1))/(Zm2-Zm1)
B = (Z1*Zm2-Z2*Zm1)/(Zm2-Zm1)

-----------
Возможно на высоких частотах коэффициэнт усиления не так точно соблютается :(
Да, фактический факт - коэффициэнты усиления на высоких частотах не очень точно соблюдаются.
Точность 1%, не более.

Для того, чтобы протестировать коэффициэне усиления - уменьшаем амплитуду сигнала,
и смотрим на выходной результат при большем коэффициэнте усиления.

Причем для центральных диапазонов достаточно тестировать 1,2,4,5

Игры престолов. Песня льда и пламени.
----------------
1,2,4,5,8,10,16,32
1KOm   
amp    KI 
1200 - 0
600 -  1
300 -  2
240 -  3
150 -  4

----------------
- проверить что calcFi выдает результаты аналогичные комплексным числам
	они аналогичны если complex(sdata["sin"], sdata["cos"])

- прикрутить коррекцию по коэффициэнтам усиления
	прикрутили, но еще не сделали интерфейса.

- для диапазона 0..1 Ом не делать коррекцию по коэффициэнтам усиления

- попробовать избавиться от преобразователя тока. 
	вход R13 закоротить на выход IC3

- похоже DAC довольно неточно работает с разными амплитудами (амплитуда DAC меняется с частотой?)
	поэтому калибровка с изменяющейся амплитудой DAC не правильная

- увеличим маскимальный размах амплитуды --ok

- посчитаем коэффициэнты усиления в зависимости от частоты --ok
	- диапазон 100 Ом для тока		
		при 1 КОм = 1,2,4,5,8,10, 16
		при 10 КОм = 32 

	- диапазон 100 Ом для напряжения 
		при 10 Ом = 1,2,4,5,8,10,16
		при 1 Ом = 32


- посчитать таки коррекцию для диапазонов 
	short - 100 Ом - 0
	100 Ом - 1КОм - 0 
	1КОм - 10 КОм - 1
	10 КОм - 100 КОм - 2
	100 KOm - open - 3


- прочекать, можно ли усиление x32 на 10 ом замерить --нельзя

- надо като определить, какой из многочисленных корректоров использовать!
	для диапазонов 1, 2, 3 - есть единственный корректор, так что ошибиться несложно
	диапазон 0 разбивается аж на 2 поддиапазона 0-100 Ом, 100 Ом - 1 КОм
	в перспективе можно и 0-100 Ом разбить на 0-1 Ом и 1-100 Ом, тогда не бцдет проблем с 32x коэффициэнтом усиления неоткалиброванным

- диапазоны 0-1 Ом и 1-100 Ом автоматически переключать --ok
- таки сделать ля 0-1 Ом коррекцию по усилению для тока --ok
- сделать переключения графиков --ok
	ser/par

- сделать окно "быстрого измерения", выбираем частоту. SER/PAR а оно измеряет --ok

- если сопротивление большое, а мнимая часть сопротивления залезла немного в индуктивную часть, --ok
  то таки показывать это как отрицательную емкость

- корректирующие коэффициэнты
	- корректировка усиления
		KI_%i KV_%i i=0..6
		7 диапазонов усиления * 2 (IV) * 2(ReIm) * 4(sizeof(float)) = 112 байт

	- корректировка по сопротивлению известному на краях диапазона
		D0_100Om, D0_1KOm, D1_1KOm, D1_10KOm, D2_10KOm, D2_100KOm
		3 диапазона * 2 края диапазона * (2(ReIm)+2 (RminRmax))* 4(sizeof(float)) = 96 байт
	- корректировка open/short/1 om
		3*2*4 = 24 байта

	- все коэффициэнты усиления для одной частоты с запасом влезают в 256 байт
		частот 4 (1e2, 1e3, 1e4, 1e5)

	- сделать рефактор, чтобы все предрасчеты в GainCorrector были вначале --ok
	- сделать рефактор, чтобы все предрасчеты в Corrector2x были вначале --все и так заранее считалось
	- сделать рефактор, чтобы все предрасчеты в CorrectorOpen были вначале --все и так заранее считалось
	- сделать рефактор, чтобы все предрасчеты в CorrectorShort были вначале --все и так заранее считалось

- переделать calculateJson, чтобы возвращало R = complex(Rre, Rim) --ok

- убрать переход в полярные координаты и обратно --ok
	z3 = z1/z2
	(x1+y1*j)/(x2+y2*j) = (x1+y1*j)*(x2-y2*j)/(x2*x2+y2*y2)
	
	в случае x2*x2+y2*y2==1
	z3 = (x1+y1*j)*(x2-y2*j) = (x1*x2+y1*y2)+(-x1*y2+x2*y1)*j

	cos(f1-f2) = cos(f1)*cos(f2)+sin(f1)*sin(f2)
	sin(f1-f2) =-cos(f1)*sin(f2)+cos(f2)*sin(f1)

	f3 = f1 - f2

- проверить, что calcAll еще работает
- сделать, чтобы Corrector не падали при остутствии корректирующих коэффициэнтов
- setGainAuto переложить на C --ok
- не забыть поменять имя девайса! --ok
- сканирование N раз после того, как определили коэффициэнт усиления. --ok
	измерения Rre, Rim на микроконтроллере
- красиво отображать R,C,L --ok
	
- не забыть проверить, что error таки false
- померять, быстрее ли хврдварные измерения вместо adcRequestLastComputeX

- таки приделать коррекции
	- gain_corrector --ok
	- Corrector2X --ok
	- open --ok
	- short --ok

- запись корректирующих коэффициэнтов во flash --ok
- автоматическая установка LowPass --ok
- продумать расположение элементов на экране и интерфейс управления --ok

- вывод на экран
	- емкости/индкутивности --ok

- меню
	- прикрутить энкодер --ок
	- прикрутить кнопку --ok
		- прикрутить 50 ms прерывание --ok
		- проверить, что кнопка нажата --ok

	- отрисовка меню --ok

	- изменяемые параметры
		частота 100 Гц, 1 КГц, 10 КГц, 100 КГц --ok
		SER/PAR --ok
		Rim или L/C --ok


- таки на средних диапазонах плохая калибровка
	это хорошо видно по R = 200 Ом
	у него и вещественное значение неправильное
	и мнимая часть слишком большая
	- построить график амплитуды/фазы для разных сопротивлений от 100 до 1000 ом	
		без коррекции 1 KHz
		     LowPass=false LowPass=true
		100  -0.006 grad
		200  0.121 grad    0.123 grad
		300  0.265 grad    0.200 grad
		680  -0.007 grad
		820  -0.009 grad

		без коррекции 100 Hz
		100 -0.081 grad
		200 -0.071 grad
		300 -0.057 grad
		680 -0.076 grad
		820 -0.080 grad

	РАЗОБРАЛИСЬ! Таки при goodMax == 4000 усилитель начинал чутка неточно усиливать.
	Ограничили goodMax == 3300 и все стало достаточно точно!!!!!!
	
- сверхнизкие частоты 10-20 Гц ??????

- измерить ток подсветки, если меньше 25 ма, прикрутить к  --ok
	прикрутили к PE1
	ток оказался 6 ма

- сделать говнощупы и проверить что они чегото измеряют --ok
- при отключенном USB зависает при инициализации.
	если инициализацию USB отключить, то программа ведет себя очень странно!
	это происходило изза строчки USB_SIL_Write(EP1_IN, (uint8_t *)"Hello", 5);, которая естественно не работала при отключенном USB

- нарисовать батарейку --ok
	ADC_BAT = PC5 ADC2_IN11
	делится напряжение так 
	3.3 KОм 2.2 KOm (можно былобы реально x10 сделать сопротивления, сэкономили бы 1 mA) 

	K = 2.2/(2.2+3.3) = 0.4
	6 V * K = 2.4

	3130 - up = 6.3 V
	2730 - down = 5.5 V

	
- сделать экранированные щупы --ok
- в графическом интерфейсе кнопка записи коректирующик коэффициэнтов во flash --ok

- совершенно неверные сопротивления для Open калибровки
	- перекалибровали на даче, все заработало
	- в старом графике был один шум :(

- посмотреть, что будет на частоте 100 КГц --fail
	- при 30 сэмплах сразу повышается десятикратно ошибка

- добавить частоты 175 КГц и 10 Гц

- добавить вид (abs(Z) Ом, tg(Z) градусов)

- облагородить заставку

- вроде меняли R7/R30 для того чтобы напряжение было 2.5 V (а не 2.2 V как на схеме)

- два раза чатота 3 КГц

- убрать шум от GainCorrector
	KV0_0.json KV0_1.json очень шумные
	попробовать измерять на 100 Ом все, но с изменяемой амплитудой сигнала

- вариант калибровки без GainCorrector
	калибруем так
	если амплитуда I канала меньше чем амплитуда V канала
		значит сопротивление больше опорного и надо только увеличивать усиления I канала
	иначе сопротивление меньше 100 ом, и надо увеличивать усиление V канала

	при калибровке уменьшаем амплитуду сигнала DAC пропорционально усилению
	
	для центральных диапазонов достаточно таких коэффициэнтов усиления 1,2,4,5,8

	для open нужны все
	для short нужны все

	- не используем КУ=5, 10
	- для центральных диапазонов (где используется Corrector2x) используем только КУ=1,2,4
	- для Open/Short диапазонов используем КУ=1,2,4,8,16,32

- пропаять цифровую и аналоговую часть несколькими проводками, а то чтото шумы больно велики на входе ADC --ok

- m0 тестирование что изменилось --ok
	- тестируем
		- freq 1 КОм на R0V0I0 amplitude=DEFAULT
		- freq 1 КОм на R0V0I2 amplitude=DEFAULT
		- out 1 КОм на R0V0I0 amplitude=DEFAULT period = 19968
		- out 1 КОм на R0V0I0 amplitude=0 period = 19968
		- out 1 КОм на R0V2I2 amplitude=0 period = 19968


- m1 припаять цифровую и аналоговую часть несколькими толстыми проводами (и глянуть не уменьшится ли амплитуда помех) --ok
- m2 перепаять резисторы из выходного RC фильтра на 120 Ом --ok
- заменить R30 на 47 КОм чтобы было 2.5 V на выходе --ok
	- перерисовать на схемке

- ввести обратно высокие частоты, до 375 KHz --ok, 1 градус отклонения dfi(uncorrected), круто!

- проблемма - при каком коэффициэнте усиления проводить open калибровку.
	дело в том что на высоких частотах емкость таки плавает
	наверно придется несколько диапазонов сканировать.

	для open калибровки пускай будет ограничение на коэффициэнт усиления
	делаем так, запускаем gain_auto на максималльной амплитуде
	определяем максимальный клэффициэнт усиления в зависимости от частоты
	при последующих измерениях больше этого коэффициэнта не используем


- вкрнуть калибровку по 1 Ом --ok
- 
	черное 100 nH
	белое 33 nH
	черно-белое 10 nH

	100 nH -> 94 nH
	33 nH -> 22 nH
	10 nH -> 1 nH
	Частота 185 KHz
	Результаты получаются достаточно стабильными. +-0.5 nH скачет на экране
	От подключения к подключению разультаты изменяется немногим менее, чем на на 1 nH.
	Результаты усредняю за 1 секунду времени.

	Короткие щупы имеют емкость на 0.5 pF+-0.02 pF больше, чем длинные.
	Длтинные щупы имеют индуктивнеость примерно на 125 nH +-15 nH больше, чем короткие.

	Заодно попробовал короткие щупы на маленьких емкостях.
	Стабильно держится +-0.001 pF и работают "магические пассы руками"
	Уже при приближение руки на расстояние 20 см от площадки добавляется пара тысячных пикофарада индуктивности :)
	Так что магические пассы руками отлично ловятся.

	Длинные щупы для таких фокусов плохо приспособленны, так как вокруг чуствительной площадки со всех сторон заземление.
	Пока все измерял, потерял пару индективностей. Всетаки деталики в SMD корпусах крайне одноразовые.


- рассчитаем объем новых корректирующих коэффициэнтов для одной частоты --ok
	- sizeof(Z) = 2*sizeof(float) = 8 байт
	- short калибровка
		sizeof(Rmax)+
		6 диапазонов усиления * (2 края* sizeof(Z)) = 100 байт

	- для load-load калибровок --ok
		3 резистора * (
		sizeof(Rmin)+sizeof(Rmax)+
		3 диапазона усиления *(2 края* sizeof(Z))) = 168 байт
		56 байт на 1 диапазон

	- open --ok
		sizeof(Rmin)+
		6 диапазонов усиления * (2 края* sizeof(Z)) = 100 байт

	- будем значит укладываться в 512 байт --ok

- 1.5 pF некорректно измеряется на некоторых частотах (слишком большое усиление) --ok
	действительно было слишком большое усиление

- частоты от 10 герц прикрутить --fail
	- поробовать увеличить SINUS_BUFFER_SIZE, посмотреть - улучшится ли результат на низких частотах -fail
	- подумать, может на низких частотах ошибка в фазе, потому как сигнал DAC чутка запаздывает?


- подумать о возвращении 250 и 375 КГц --ok
- добавить ограничение gainCurrentIdx для resistorIdx==3 --ok
- сделать пару директорий для корректирующих коэффициэнтов для разных щупов
- ProcessStartComputeX параметр count ни на что не влияет?
- добавить 250 КГц для измерения в железо. --ok
- посммотреть сколько значащих цифр выводится
	вместо 22.6 КОм должно быть 22.62 КОм

    ДОКУМЕНТАЦИЯ
https://code.google.com/p/rlc-meter-balmer/
http://wiki.rlc-meter-balmer.googlecode.com/hg/images/RLC0.JPG

- описание щупов --ok
- описание точности прибора
	- немного про точность, картинки моих приборов с корорыми сравнивал
	  объяснение психологии, когда человек думает, что прибор с точностью 0.5% имеет точность существенно выше
	- рассказ о том, почему графики - это хорошо.
	- красивые графики точности на "core" диапазоне.
		- сопротивление
		- индуктивность
		- емкость
		- колебательный контур

- описание схемотехники

- логику is_short перенести в железо

- Corrector2x - возможно вкорне неправильный
  ошибка фазы при измерении большого сопротивления плохо влияет на малые сопротивоения?

  - попробовать "open" калибровку на 100 Ом -круто пошло, точность сразу увеличилась в 5 раз на 200 Ом резисторе
  - на резисторе 8200 Ом open калибровка дает результат значительно хуже, чем Corrector2x



- сравнение параметров
	Сопротивления
	* DE = LCR METER DE-5000
Резисторы до 100 КОм измерялись с Serial схемой замещения
Выше 100 КОм - с параллельной схемой замещения (это важно на высокой частоте)

			My 100 Hz 	My 1 KHz 	My 10 KHz 	My 93 KHz 	UT71A 	DE 100 Hz 	DE 1 KHz 	DE 10 KHz 	DE 100 KHz
22 Om 		21.75 Om 	21.75 Om 	21.77 Om 	21.76 Om	21.71	21.75 		21.76 		21.77 		21.76
200 Om 1%	200.10 Om 	200.15 Om 	199.98 Om 	200.03 Om 	198.7 	199.8 		200.0 		199.9 		199.9
680 Om 		668.50 Om 	668.65 Om 	667.95 Om 	668.44 Om 	668.3 	668.7 		668.8 		668.1 		668.5 		
2200 Om 	2211 Om 	2211 Om 	2210 Om 	2211 Om 	2195 	2212 		2210 		2211 		2211
22 KOm 		21.70 KOm 	21.71 KOm 	21.71 KOm 	21.72 KOm 	21.32 	21.69 		21.70 		21.69 		21.70
220 KOm 	220-221 	220.2 KOm 	220.15 KOm 	221.2 KOm 	216.4 	220.0 		220.2 		220.4 		218
1 MOm 		983-985 	982 KOm 	981.34 KOm  990.6 KOm 	984.6 	985 		986 		985 		968
10 MOm 		9900-9943 	9400-9700   9600-9900 	9700 		9932 	9940 		9926 		9870 		----


Конденсаторы меньше 1 uF измерялись с parallel схемой замещения (второй параметр - угол в градусах)
Больше 1 uF с serial схемой замещения (Второй мараметр - ESR мОм)

			My 100 Hz 	My 1 KHz 	My 10 KHz 	My 93 KHz 	UT71A 	DE 100 Hz 	DE 1 KHz 	DE 10 KHz 	DE 100 KHz
1.5 pF 		1.4-1.5 	1.70-1.72 	1.677 		1.628 		--- 	2 			1.9 		1.88 		1.87
			-83...-92   -90..-92 	-90.01 		-91.18 				-88.6 		-89.6 		-89.7 		-89.5

1.5 nF		1.46		1.55 		1.53 		1.50  		1.59 	1.58 		1.55 		1.53 		1.50
			-89.5 		-89.3 		-89.3 		-89.1 				-89.2 		-89.3 		-89.2 		-89.0

470 nF 		396.8 		398.0 		397.4 		396.3 		398 	398.0 		397.9 		397.7 		397.4
250 V 		-90.00 		-89.98 		-89.95 		-89.49 				-90.0 		-90.0 		-90.0 		-89.2

22 uF 		20.1 		18.1 		15.8 		9.81 		21.28 	20.1 		18.1 		15.9 		16.0
63 V 		5850 		1510 		917 		803 				5700 		1470 		900 		800

220 uF 		195.2 		187.2 		165.3 		--- 		199.6 	194.6 		186.0 		165.3 		---
35 V 		382 		210 		183 		170 				300 		210 		180 		---

2200 uF 	2051 		1972 		1883 		--- 		2144 	2030 		1970 		---         ---
25 V 		48 			34 			32 			32 					0 			30 	        ---         ---

* При измерении емкости 1.5 pF при помощи DE-5000 вычитали емкость на открытых щупах вручную.

Долгострочная нестабильность. 
За неделю параметры на открытых щупах ушди на 0.015 pF
На замкнутых щупах на 1 mOm приблизительно

DE Емкость
100 - 0
1 KHz - 0.6 pF
10 KHz - 0.68 pF
100 KHz - 0.69 pF

Индуктивности
			My 100 Hz 	My 1 KHz 	My 10 KHz 	My 93 KHz 	DE 100 Hz 	DE 1 KHz 	DE 10 KHz 	DE 100 KHz
1 uH		0.8-1.1 	0.98-1.05 	1.02-1.03 	921 		1 			1 			1.06 		954
ESR mOm		115 		115			120 		142 		100 		110 		120 		90

100 uH 		84 			89.7 		90.0 		89.0 		91 			91.5 		91.0 		90.0
ESR mOm 	86 			88 			135 		2382 		0 			90 			170 		3100

Relay mH 	323.0 		133.5 		35.3		8.13		401.9 		148.9 		35.4 		7.68
ESR Om 		233.5 		768 		2654 		7269 		247 		929 		2930 		7610

Trans H 	9.11 H 		8.22 H 		277 pF 		51 pF 		10.9 H 		8.58 H 		9 pF 		53 pF
ESR KOm		0.800 		10.86 		349 		1.50 		1.20 		13.0        --- 		---


- обновить код микроконтроллера для нового типа калибровки. --ok
- увеличить количество значащих знаков --ok
- первоначальная заставка --ok
- угол в градусах --ok
- страничка с кучей графиков --ok
- страничка с описанием процесса калибрации и других возможностей подключения к компьютеру. --ok
- оглавление --ok

- попробовать еще уменьшить RC цепочку перед DAC Поставить там 10 Ом?

- посмотреть на нелинейную ошибку
	- out.json сглаженный в N раз получить
	- вычесть регуярную часть сигнала

- останавливать непрервыную генерацию, когда начали измерения с компьютера

- добавить пункт "калибровка"
	- сделать меню для большого количества пунктов --ok
	- зачистить flash --ok

	- редактор сопротивления --ok
		на экране появляется сопротивление
		сначала изменяется самая грубая цифра
		при нажатии на кнопку - переходим к более мелкому разряду
		Когда все разряды измененны - редактирование оконченно.

	- убрать ненужные индексы для измерения в main.py FormCalibrationResistor --ok
		Так как мы не используем Corrector2x, то они точно есть.
		Список ненужного
			100 Ом
			{'resistorIndex': 0, 'VIndex':7, 'IIndex':0, 'div': 32},
			{'resistorIndex': 0, 'VIndex':0, 'IIndex':2, 'div': 4},			

			1 KOm
			{'resistorIndex': 0, 'VIndex':0, 'IIndex':0, 'div': 1},
            {'resistorIndex': 0, 'VIndex':0, 'IIndex':1, 'div': 1},
            {'resistorIndex': 1, 'VIndex':0, 'IIndex':2, 'div': 4},

            10 KOm
            {'resistorIndex': 1, 'VIndex':0, 'IIndex':0, 'div': 1},
            {'resistorIndex': 1, 'VIndex':0, 'IIndex':1, 'div': 1},
            {'resistorIndex': 2, 'VIndex':0, 'IIndex':2, 'div': 4},

            100 KOm
            {'resistorIndex': 2, 'VIndex':0, 'IIndex':0, 'div': 1},
            {'resistorIndex': 2, 'VIndex':0, 'IIndex':1, 'div': 1},


    - ожидание для утсканивания переходных процессов после переключения диапазона --ok
    - short калибровка


    - запуск калибровки
    	включение с определенными коэффициэнтами усиления в каналах
    	когда результат получен - вызов callback для измерения 
    	когда все просчитано, отрисовка диалога
	- калибровка происходит для текущей выбранной частоты
		- выбираем какой из резистор подключен
			short/ 100 Om/ 1 KOm/ 10 KOm/ 100 KOm/ open.
		- изменяем значение сопротивления, если необходимо.
		- измеряем во всех требуемых режимах, потом записываем в оперативную память.
		- нажимаем на SAVE.


- обновить документацию
	- калибровка с устройства
		- особенность - open калибровку нужно проводить до 100 RJv калибровки
	- схема от barby
